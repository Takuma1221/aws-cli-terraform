# AWS S3 & CloudFront 構成設定ガイド

このドキュメントでは、Terraform を使用して AWS S3 と CloudFront を構築する際に必要な設定項目と、その意味について解説します。

## 1. S3 (Simple Storage Service) の設定

S3 は静的コンテンツ（HTML, CSS, JS, 画像など）を保存するオリジンサーバーとして機能します。

### 必要な主な情報

| 設定項目                       | 説明                                                               | 必須 | 備考                                                                              |
| :----------------------------- | :----------------------------------------------------------------- | :--- | :-------------------------------------------------------------------------------- |
| **バケット名**                 | 全世界で一意な名前である必要があります。                           | ✅   | DNS 準拠の命名規則に従う必要があります。                                          |
| **パブリックアクセスブロック** | バケットへの直接アクセスを制御します。                             | ✅   | CloudFront 経由のみ許可するため、**すべてブロック (True)** に設定します。         |
| **バケットポリシー**           | バケット内のオブジェクトへのアクセス権限を JSON 形式で定義します。 | ✅   | CloudFront (OAC) からのアクセスのみを許可するポリシーを設定します。               |
| **オブジェクト**               | アップロードするファイルとそのコンテンツタイプ。                   | -    | `content_type` を正しく設定しないと、ブラウザで正しく表示されない場合があります。 |

---

## 2. CloudFront (CDN) の設定

CloudFront は S3 のコンテンツをキャッシュし、ユーザーに近いエッジロケーションから高速に配信します。

### 必要な主な情報

| 設定項目                        | 説明                                                           | 必須 | 備考                                                                                       |
| :------------------------------ | :------------------------------------------------------------- | :--- | :----------------------------------------------------------------------------------------- |
| **Origin (オリジン)**           | コンテンツの取得元。今回は S3 バケットのドメインを指定します。 | ✅   | `bucket_regional_domain_name` を使用します。                                               |
| **OAC (Origin Access Control)** | S3 へのアクセスを CloudFront に限定するための認証設定。        | ✅   | 以前の OAI (Origin Access Identity) の後継機能です。                                       |
| **Default Cache Behavior**      | キャッシュの動作設定（TTL、許可メソッド、プロトコルなど）。    | ✅   | `viewer_protocol_policy` で HTTPS を強制 (`redirect-to-https`) します。                    |
| **Viewer Certificate**          | HTTPS 通信に使用する SSL/TLS 証明書。                          | ✅   | デフォルト証明書 (`cloudfront_default_certificate = true`) または ACM 証明書を使用します。 |
| **Web ACL ID**                  | 適用する AWS WAF の Web ACL の ID (ARN)。                      | -    | IP 制限などを行う場合に紐付けます。                                                        |
| **Custom Error Response**       | エラー発生時（403, 404 など）の振る舞い。                      | -    | SPA (Single Page Application) やカスタムエラーページを表示する場合に設定します。           |

---

## 3. AWS WAF (Web Application Firewall) の設定

WAF は CloudFront へのアクセスを検査し、不正なリクエストや許可されていない IP からのアクセスをブロックします。

### 必要な主な情報

| 設定項目    | 説明                                                                            | 必須 | 備考                                                                                       |
| :---------- | :------------------------------------------------------------------------------ | :--- | :----------------------------------------------------------------------------------------- |
| **Scope**   | WAF を適用する範囲。                                                            | ✅   | CloudFront に適用する場合は `CLOUDFRONT`、ALB などの場合は `REGIONAL` を指定します。       |
| **IP Set**  | 許可または拒否する IP アドレスのリスト (CIDR 形式)。                            | -    | IPv4 と IPv6 は別々の IP Set として作成する必要があります。                                |
| **Web ACL** | ルールをまとめるコンテナ。デフォルトのアクション（許可/ブロック）を定義します。 | ✅   | 今回は「デフォルトでブロック、特定 IP のみ許可」というホワイトリスト方式を採用しています。 |
| **Rules**   | 具体的な検査ルール。IP Set を参照して判定を行います。                           | -    | 優先順位 (`priority`) を設定して評価順序を制御します。                                     |

---

## 4. 設定の関連図

各リソースは以下のように関連し合っています。

```mermaid
graph TD
    User[ユーザー] -->|HTTPS Access| CF[CloudFront Distribution]

    subgraph "AWS WAF"
        WAF[Web ACL] -->|IP Check| CF
        IPSet[IP Set (v4/v6)] -->|Reference| WAF
    end

    CF -->|OAC Auth| S3[S3 Bucket]

    subgraph "S3 Security"
        BP[Bucket Policy] -->|Allow OAC| S3
        PAB[Public Access Block] -->|Block All| S3
    end
```

1.  **WAF** が **CloudFront** へのアクセスをフィルタリングします。
2.  **CloudFront** は **OAC** を使用して **S3** にリクエストを送ります。
3.  **S3** は **バケットポリシー** で **OAC** からのリクエストのみを許可し、それ以外（直接アクセスなど）を拒否します。
